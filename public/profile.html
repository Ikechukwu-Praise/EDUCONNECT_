<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - EduConnect</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#7c3aed',
            'primary-dark': '#6d28d9',
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <!-- Navigation -->
  <nav class="sticky top-0 z-50 bg-white border-b border-gray-200">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-8">
          <a href="dashboard.html" class="flex items-center gap-2">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <span class="text-xl font-bold">EduConnect</span>
          </a>
          <div class="hidden md:flex gap-6">
            <a href="dashboard.html" class="text-gray-600 hover:text-purple-600">Dashboard</a>
            <a href="subjects.html" class="text-gray-600 hover:text-purple-600">Subjects</a>
            <a href="rooms.html" class="text-gray-600 hover:text-purple-600">Study Rooms</a>
            <a href="profile.html" class="text-purple-600 font-medium">Profile</a>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 bg-purple-50 px-4 py-2 rounded-lg">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="coinBalance" class="font-semibold text-purple-600">0</span>
          </div>
          <button id="logoutBtn" class="text-gray-600 hover:text-red-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-6 py-8">
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">Your Profile</h1>
        <p class="text-gray-600">Manage your account and track your progress</p>
      </div>
      <button id="editProfileBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-300">
        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        Edit Profile
      </button>
    </div>

    <div class="grid lg:grid-cols-4 gap-8">
      <!-- Profile Card -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-purple-500 via-pink-500 to-red-500"></div>
          <div class="relative z-10">
            <div class="w-32 h-32 mx-auto mb-6 relative">
              <img id="profilePhoto" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg cursor-pointer hover:scale-105 transition-transform duration-300" src="" alt="Profile" style="display: none;">
              <div id="profilePhotoPlaceholder" class="w-32 h-32 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center cursor-pointer hover:scale-105 transition-transform duration-300 border-4 border-white shadow-lg" onclick="document.getElementById('profilePhotoInput').click()">
                <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
              <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
            </div>
            <h2 id="profileName" class="text-2xl font-bold text-gray-900 mb-2">Loading...</h2>
            <p id="profileEmail" class="text-gray-600 text-sm mb-4"></p>
            <div class="space-y-2 mb-6">
              <div class="flex items-center justify-center gap-2 text-purple-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span id="profileCountry" class="font-medium">Country not set</span>
              </div>
              <div class="flex items-center justify-center gap-2 text-gray-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                <span id="profileClass" class="text-sm">Class not set</span>
              </div>
              <div class="flex items-center justify-center gap-2 text-gray-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <span id="profileUniversity" class="text-sm">School not set</span>
              </div>
            </div>

            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 mb-6">
              <div class="flex items-center justify-between mb-2">
                <span class="text-gray-700 font-medium">Coin Balance</span>
                <div class="flex items-center gap-1">
                  <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
                  </svg>
                  <span id="profileCoins" class="text-2xl font-bold text-purple-600">0</span>
                </div>
              </div>
              <button id="buyCoinsBtn" onclick="window.location.href='buy-coins.html'" class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-2 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-300 font-semibold">
                ðŸ’° Buy Coins
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="lg:col-span-3 space-y-8">
        <!-- Activity Stats -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <h3 class="text-2xl font-bold text-gray-900 mb-6">Activity Statistics</h3>
          <div class="grid grid-cols-3 gap-6">
            <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl border border-purple-200">
              <p class="text-3xl font-bold text-purple-600 mb-1" id="statsUploads">0</p>
              <p class="text-sm text-purple-700 font-medium">Uploads</p>
            </div>
            <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200">
              <p class="text-3xl font-bold text-blue-600 mb-1" id="statsDownloads">0</p>
              <p class="text-sm text-blue-700 font-medium">Downloads</p>
            </div>
            <div class="text-center p-6 bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl border border-pink-200">
              <p class="text-3xl font-bold text-pink-600 mb-1" id="statsRooms">0</p>
              <p class="text-sm text-pink-700 font-medium">Study Rooms</p>
            </div>
          </div>
        </div>

        <!-- Selected Subjects -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <h3 class="text-2xl font-bold text-gray-900 mb-6">Selected Subjects</h3>
          <div id="selectedSubjects" class="flex flex-wrap gap-3">
            <p class="text-gray-500 italic">No subjects selected</p>
          </div>
        </div>

        <!-- Friends & Achievements -->
        <div class="grid md:grid-cols-2 gap-8">
          <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-xl font-bold text-gray-900">Friends</h3>
              <div class="flex gap-2">
                <button id="friendRequestsBtn" class="bg-orange-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-orange-600 transition relative">
                  <span id="requestCount" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                  Requests
                </button>
                <button id="addFriendBtn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:shadow-lg transform hover:scale-105 transition-all duration-300">
                  + Add Friend
                </button>
              </div>
            </div>
            <div id="friendsList" class="space-y-3">
              <p class="text-gray-500 italic text-center py-4">No friends yet</p>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow-xl p-8">
            <h3 class="text-xl font-bold text-gray-900 mb-6">Achievements</h3>
            <div id="achievementsList" class="grid grid-cols-2 gap-3">
              <p class="text-gray-500 italic text-center py-4 col-span-2">No achievements yet</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Buy Coins Modal -->
  <div id="buyCoinsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4 z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full">
      <h2 class="text-2xl font-bold mb-6">Buy Coins</h2>
      <div class="space-y-3 mb-6">
        <button onclick="buyCoins(20, 7.00)" class="w-full p-4 border-2 border-gray-200 rounded-lg hover:border-purple-600 transition text-left">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-bold text-lg">20 Coins</p>
              <p class="text-sm text-gray-600">Starter Pack</p>
            </div>
            <p class="text-2xl font-bold text-purple-600">$7.00</p>
          </div>
        </button>
        <button onclick="buyCoins(50, 17.00)" class="w-full p-4 border-2 border-gray-200 rounded-lg hover:border-purple-600 transition text-left">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-bold text-lg">50 Coins</p>
              <p class="text-sm text-gray-600">Popular Choice</p>
            </div>
            <p class="text-2xl font-bold text-purple-600">$17.00</p>
          </div>
        </button>
        <button onclick="buyCoins(100, 33.00)" class="w-full p-4 border-2 border-purple-600 bg-purple-50 rounded-lg transition text-left">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-bold text-lg">100 Coins</p>
              <p class="text-sm text-purple-600">Best Value!</p>
            </div>
            <p class="text-2xl font-bold text-purple-600">$33.00</p>
          </div>
        </button>
      </div>
      <button id="closeBuyCoins" class="w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Close</button>
    </div>
  </div>

  <!-- Friend Requests Modal -->
  <div id="friendRequestsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4 z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Friend Requests</h2>
        <button id="closeFriendRequests" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="pendingRequests" class="space-y-4">
        <p class="text-gray-500 italic text-center py-4">No pending requests</p>
      </div>
    </div>
  </div>

  <!-- Add Friend Modal -->
  <div id="addFriendModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4 z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full">
      <h2 class="text-2xl font-bold mb-6">Add Friend</h2>
      <form id="addFriendForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Friend's Email</label>
          <input type="email" id="friendEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="friend@example.com">
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Message (Optional)</label>
          <textarea id="friendMessage" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Hi! Let's connect on EduConnect..."></textarea>
        </div>
        <div class="flex gap-4">
          <button type="button" id="cancelAddFriend" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Send Request</button>
        </div>
      </form>
    </div>
  </div>
  <div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4 z-50">
    <div class="bg-white rounded-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-6">Edit Profile</h2>
      <form id="editProfileForm">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
            <input type="text" id="editFullName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
            <select id="editCountry" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
              <option value="">Select Country</option>
              <option value="United States">United States</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="India">India</option>
              <option value="Australia">Australia</option>
              <option value="Canada">Canada</option>
              <option value="Netherlands">Netherlands</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Class/Level</label>
            <select id="editClassLevel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
              <option value="">Select Class/Level</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">University/School</label>
            <input type="text" id="editUniversity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Profile Photo</label>
          <div class="space-y-3">
            <input type="file" id="profilePhotoFile" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
            <div class="text-center">
              <span class="text-gray-500 text-sm">or</span>
            </div>
            <input type="url" id="editPhotoUrl" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Enter photo URL...">
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
          <textarea id="editBio" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Tell us about yourself..."></textarea>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Your Subjects</label>
          <div id="subjectCheckboxes" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
            <!-- Subject checkboxes will be loaded here -->
          </div>
        </div>
        <div class="flex gap-4">
          <button type="button" id="cancelEdit" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://uclvqmoeiybrauenbqau.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjbHZxbW9laXlicmF1ZW5icWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODgxMTYsImV4cCI6MjA4MTU2NDExNn0.cKYUsuLMSb980-x-_Zrb39x10ptSf-U7AzBA6pSIuto'
    // Use a single global Supabase client to avoid redeclaration errors when multiple
    // scripts declare clients on the same page. Store it on window.__edu_supabase.
    window.__edu_supabase = window.__edu_supabase || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    const supabaseClient = window.__edu_supabase

    // Helper Functions
    function showToast(message, type = 'success') {
      const toast = document.createElement('div')
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} shadow-lg z-50`
      toast.textContent = message
      document.body.appendChild(toast)

      setTimeout(() => {
        toast.remove()
      }, 3000)
    }

    async function checkAuth() {
      const { data: { user } } = await supabaseClient.auth.getUser()
      if (!user) {
        window.location.href = 'login.html'
      }
      return user
    }

    async function getUserProfile(userId) {
      const { data } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single()
      return data
    }

    async function uploadProfilePhoto(file, userId) {
      try {
        console.log('uploadProfilePhoto: start', file.name, userId)
        // Show loading state
        document.getElementById('profilePhotoPlaceholder').innerHTML = '<div class="w-5 h-5 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"></div>'
        
        // Create filename with user folder structure
        const fileExt = file.name.split('.').pop()
        const filename = `${userId}/avatar-${Date.now()}.${fileExt}`
        
        console.log('Uploading to:', filename)
        
        const { data, error } = await supabaseClient.storage
          .from('avatars')
          .upload(filename, file, { 
            cacheControl: '3600',
            upsert: true 
          })

        if (error) {
          console.error('Storage upload error:', error)
          throw error
        }

        console.log('Upload successful:', data)

        const { data: publicUrl } = supabaseClient.storage
          .from('avatars')
          .getPublicUrl(filename)

        console.log('Public URL:', publicUrl.publicUrl)

        // Update profile with photo URL
        const { error: updateError } = await supabaseClient
          .from('profiles')
          .update({ profile_photo_url: publicUrl.publicUrl })
          .eq('id', userId)

        if (updateError) {
          console.error('Profile update error:', updateError)
          throw updateError
        }

        console.log('uploadProfilePhoto: success', publicUrl.publicUrl)
        return publicUrl.publicUrl
      } catch (error) {
        console.error('Photo upload error:', error)
        document.getElementById('profilePhotoPlaceholder').innerHTML = '<svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>'
        showToast(`Error uploading photo: ${error.message}`, 'error')
        return null
      }
    }

    async function handlePhotoUpload(event) {
      const user = await checkAuth()
      const file = event.target.files[0]
      if (!file) return
      console.log('handlePhotoUpload: file selected', file.name)
      showToast('Uploading photo...')
      const photoUrl = await uploadProfilePhoto(file, user.id)
      if (photoUrl) {
        // Add timestamp to URL to bypass cache
        document.getElementById('profilePhoto').src = photoUrl + '?t=' + Date.now()
        document.getElementById('profilePhoto').style.display = 'block'
        document.getElementById('profilePhotoPlaceholder').style.display = 'none'
        showToast('Profile photo uploaded successfully!')
        
        // Reload profile data to ensure everything is synced
        setTimeout(() => {
          loadProfile()
        }, 1000)
      }
    }

    // Load Navigation
    async function loadNav() {
      const user = await checkAuth()
      if (!user) return

      const profile = await getUserProfile(user.id)

      const nav = `
        <nav class="bg-white border-b border-gray-200">
          <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-8">
                <a href="dashboard.html" class="flex items-center gap-2">
                  <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                  <span class="text-xl font-bold">EduConnect</span>
                </a>
                <div class="hidden md:flex gap-6">
                  <a href="dashboard.html" class="text-gray-600 hover:text-purple-600">Dashboard</a>
                  <a href="subjects.html" class="text-gray-600 hover:text-purple-600">Subjects</a>
                  <a href="rooms.html" class="text-gray-600 hover:text-purple-600">Study Rooms</a>
                  <a href="profile.html" class="text-purple-600 font-medium">Profile</a>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-purple-50 px-4 py-2 rounded-lg">
                  <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span class="font-semibold text-purple-600">${profile?.coins || 0}</span>
                </div>
                <button id="navLogoutBtn" class="text-gray-600 hover:text-red-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </nav>
      `

      // If a static <nav> exists, replace it; otherwise inject into #app
      const existingNav = document.querySelector('nav')
      if (existingNav) {
        existingNav.outerHTML = nav
      } else {
        document.getElementById('app').innerHTML = nav
      }

      // Attach logout event listener after nav injection
      const logoutBtn = document.getElementById('navLogoutBtn')
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async (e) => {
          e.preventDefault()
          try {
            const { error } = await supabaseClient.auth.signOut()
            if (error) console.error('Logout error:', error)
            localStorage.clear()
            sessionStorage.clear()
            setTimeout(() => {
              window.location.href = 'index.html'
            }, 500)
          } catch (err) {
            console.error('Logout failed:', err)
            window.location.href = 'index.html'
          }
        })
      }
    }

    async function logout() {
      try {
        const { error } = await supabaseClient.auth.signOut()
        if (error) console.error('Logout error:', error)
        localStorage.clear()
        sessionStorage.clear()
        setTimeout(() => {
          window.location.href = 'index.html'
        }, 500)
      } catch (err) {
        console.error('Logout failed:', err)
        window.location.href = 'index.html'
      }
    }

    // Profile Logic
    async function loadProfile() {
      await loadNav()
      const user = await checkAuth()
      if (!user) return

      const profile = await getUserProfile(user.id)

      // Update profile info
      document.getElementById('profileName').textContent = profile?.full_name || 'Student'
      document.getElementById('profileEmail').textContent = user.email
      document.getElementById('profileCountry').textContent = profile?.country || 'Country not set'
      document.getElementById('profileClass').textContent = profile?.class_level || 'Class not set'
      document.getElementById('profileUniversity').textContent = profile?.university || 'School not set'
      document.getElementById('profileCoins').textContent = profile?.coins || 0

      // Update profile photo
      if (profile?.profile_photo_url) {
        document.getElementById('profilePhoto').src = profile.profile_photo_url
        document.getElementById('profilePhoto').style.display = 'block'
        document.getElementById('profilePhotoPlaceholder').style.display = 'none'
      } else {
        document.getElementById('profilePhoto').style.display = 'none'
        document.getElementById('profilePhotoPlaceholder').style.display = 'flex'
      }

      // Add click handlers for photo upload
      document.getElementById('profilePhoto').addEventListener('click', () => {
        document.getElementById('profilePhotoInput').click()
      })
      document.getElementById('profilePhotoPlaceholder').addEventListener('click', () => {
        document.getElementById('profilePhotoInput').click()
      })

      // Load selected subjects
      const { data: userSubjects } = await supabaseClient
        .from('user_subjects')
        .select('subjects(name)')
        .eq('user_id', user.id)

      const subjectsContainer = document.getElementById('selectedSubjects')
      if (userSubjects && userSubjects.length > 0) {
        subjectsContainer.innerHTML = userSubjects
          .map(us => `<span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm">${us.subjects.name}</span>`)
          .join('')
      }

      // Load stats
      const { data: uploads } = await supabaseClient
        .from('resources')
        .select('*', { count: 'exact' })
        .eq('uploader_id', user.id)

      const { data: downloads } = await supabaseClient
        .from('resource_downloads')
        .select('*', { count: 'exact' })
        .eq('user_id', user.id)

      const { data: rooms } = await supabaseClient
        .from('study_room_participants')
        .select('*', { count: 'exact' })
        .eq('user_id', user.id)

      document.getElementById('statsUploads').textContent = uploads?.length || 0
      document.getElementById('statsDownloads').textContent = downloads?.length || 0
      document.getElementById('statsRooms').textContent = rooms?.length || 0
      
      // Set up Buy Coins button after DOM is ready
      document.getElementById('buyCoinsBtn').addEventListener('click', () => {
        window.location.href = 'payment.html?coins=50&price=4.99'
      })
    }

    // Buy Coins - Direct to Payment (will be set up after profile loads)

    document.getElementById('closeBuyCoins').addEventListener('click', () => {
      document.getElementById('buyCoinsModal').classList.add('hidden')
    })

    function buyCoins(amount, price) {
      // Close modal and redirect to payment page
      document.getElementById('buyCoinsModal').classList.add('hidden')
      window.location.href = `payment.html?coins=${amount}&price=${price}`
    }

    // Edit Profile Modal
    document.getElementById('editProfileBtn').addEventListener('click', async () => {
      const user = await checkAuth()
      const profile = await getUserProfile(user.id)
      
      // Populate form with current data
      document.getElementById('editFullName').value = profile?.full_name || ''
      document.getElementById('editCountry').value = profile?.country || ''
      document.getElementById('editUniversity').value = profile?.university || ''
      document.getElementById('editPhotoUrl').value = profile?.profile_photo_url || ''
      document.getElementById('editBio').value = profile?.bio || ''
      
      // Load class levels based on country
      if (profile?.country) {
        await loadClassLevels(profile.country)
        document.getElementById('editClassLevel').value = profile?.class_level || ''
      }
      
      // Load subjects and user selections
      await loadSubjectsForEdit(user.id)
      
      document.getElementById('editProfileModal').classList.remove('hidden')
    })

    document.getElementById('cancelEdit').addEventListener('click', () => {
      document.getElementById('editProfileModal').classList.add('hidden')
    })

    document.getElementById('editCountry').addEventListener('change', async (e) => {
      await loadClassLevels(e.target.value)
    })

    async function loadClassLevels(country) {
      if (!country) return
      
      const { data: levels } = await supabaseClient
        .from('class_levels')
        .select('*')
        .eq('country', country)
        .order('sort_order')
      
      const select = document.getElementById('editClassLevel')
      select.innerHTML = '<option value="">Select Class/Level</option>' +
        levels.map(l => `<option value="${l.level_name}">${l.level_name}</option>`).join('')
    }

    async function loadSubjectsForEdit(userId) {
      const { data: subjects } = await supabaseClient.from('subjects').select('*').order('name')
      const { data: userSubjects } = await supabaseClient
        .from('user_subjects')
        .select('subject_id')
        .eq('user_id', userId)
      
      const selectedIds = userSubjects?.map(us => us.subject_id) || []
      
      const container = document.getElementById('subjectCheckboxes')
      container.innerHTML = subjects.map(s => `
        <label class="flex items-center space-x-2 text-sm">
          <input type="checkbox" value="${s.id}" ${selectedIds.includes(s.id) ? 'checked' : ''} class="text-purple-600">
          <span>${s.name}</span>
        </label>
      `).join('')
    }

    // Note: uploadProfilePhoto(file, userId) is defined earlier and used by both
    // the inline uploader and the edit form. Do not redefine it here.

    document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const user = await checkAuth()
      let photoUrl = document.getElementById('editPhotoUrl').value
      
      const photoFile = document.getElementById('profilePhotoFile').files[0]
      if (photoFile) {
        photoUrl = await uploadProfilePhoto(photoFile, user.id)
        if (!photoUrl) return
      }
      
      const formData = {
        full_name: document.getElementById('editFullName').value,
        country: document.getElementById('editCountry').value,
        class_level: document.getElementById('editClassLevel').value,
        university: document.getElementById('editUniversity').value,
        profile_photo_url: photoUrl,
        bio: document.getElementById('editBio').value
      }
      
      // Update profile
      const { error: profileError } = await supabaseClient
        .from('profiles')
        .update(formData)
        .eq('id', user.id)
      
      // Update selected subjects
      const selectedSubjects = Array.from(document.querySelectorAll('#subjectCheckboxes input:checked'))
        .map(cb => parseInt(cb.value))
      
      // Delete existing selections
      await supabaseClient.from('user_subjects').delete().eq('user_id', user.id)
      
      // Insert new selections
      if (selectedSubjects.length > 0) {
        const { error: subjectsError } = await supabaseClient
          .from('user_subjects')
          .insert(selectedSubjects.map(subjectId => ({ user_id: user.id, subject_id: subjectId })))
      }
      
      if (profileError) {
        showToast('Error updating profile', 'error')
      } else {
        showToast('Profile updated successfully!')
        document.getElementById('editProfileModal').classList.add('hidden')
        loadProfile()
      }
    })

    // Add Friend Modal
    document.getElementById('addFriendBtn').addEventListener('click', () => {
      document.getElementById('addFriendModal').classList.remove('hidden')
    })

    document.getElementById('cancelAddFriend').addEventListener('click', () => {
      document.getElementById('addFriendModal').classList.add('hidden')
    })

    document.getElementById('addFriendForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const email = document.getElementById('friendEmail').value
      const message = document.getElementById('friendMessage').value
      await addFriend(email, message)
      document.getElementById('addFriendModal').classList.add('hidden')
      document.getElementById('addFriendForm').reset()
    })

    async function addFriend(email, message = '') {
      const user = await checkAuth()
      
      // Find user by email
      const { data: friendProfile } = await supabaseClient
        .from('profiles')
        .select('id, full_name')
        .eq('email', email)
        .single()
      
      if (!friendProfile) {
        showToast('User not found', 'error')
        return
      }
      
      if (friendProfile.id === user.id) {
        showToast('You cannot add yourself as a friend', 'error')
        return
      }
      
      // Check if friendship already exists
      const { data: existing } = await supabaseClient
        .from('friendships')
        .select('*')
        .or(`and(requester_id.eq.${user.id},addressee_id.eq.${friendProfile.id}),and(requester_id.eq.${friendProfile.id},addressee_id.eq.${user.id})`)
        .single()
      
      if (existing) {
        showToast('Friend request already exists or you are already friends', 'error')
        return
      }
      
      const { error } = await supabaseClient
        .from('friendships')
        .insert({
          requester_id: user.id,
          addressee_id: friendProfile.id,
          status: 'pending',
          message: message
        })
      
      if (error) {
        showToast('Error sending friend request', 'error')
      } else {
        showToast(`Friend request sent to ${friendProfile.full_name}!`)
      }
    }

    // Friend Requests Modal
    document.getElementById('friendRequestsBtn').addEventListener('click', () => {
      document.getElementById('friendRequestsModal').classList.remove('hidden')
      loadFriendRequests()
    })

    document.getElementById('closeFriendRequests').addEventListener('click', () => {
      document.getElementById('friendRequestsModal').classList.add('hidden')
    })

    async function loadFriendRequests() {
      const user = await checkAuth()
      const { data: requests } = await supabaseClient
        .from('friendships')
        .select(`
          *,
          requester:profiles!friendships_requester_id_fkey(full_name, profile_photo_url)
        `)
        .eq('addressee_id', user.id)
        .eq('status', 'pending')
        .order('created_at', { ascending: false })
      
      const container = document.getElementById('pendingRequests')
      const countBadge = document.getElementById('requestCount')
      
      if (requests && requests.length > 0) {
        countBadge.textContent = requests.length
        countBadge.classList.remove('hidden')
        
        container.innerHTML = requests.map(req => `
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                ${req.requester.profile_photo_url ? 
                  `<img src="${req.requester.profile_photo_url}" class="w-10 h-10 rounded-full object-cover">` :
                  `<span class="text-sm font-bold text-purple-600">${req.requester.full_name[0]}</span>`
                }
              </div>
              <div class="flex-1">
                <p class="font-semibold">${req.requester.full_name}</p>
                <p class="text-sm text-gray-500">wants to be your friend</p>
              </div>
            </div>
            ${req.message ? `<p class="text-sm text-gray-600 mb-3 italic">"${req.message}"</p>` : ''}
            <div class="flex gap-2">
              <button onclick="respondToRequest('${req.id}', 'accepted')" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-green-700">
                Accept
              </button>
              <button onclick="respondToRequest('${req.id}', 'rejected')" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-700">
                Decline
              </button>
            </div>
          </div>
        `).join('')
      } else {
        countBadge.classList.add('hidden')
        container.innerHTML = '<p class="text-gray-500 italic text-center py-4">No pending requests</p>'
      }
    }

    async function respondToRequest(requestId, status) {
      const { error } = await supabaseClient
        .from('friendships')
        .update({ status })
        .eq('id', requestId)
      
      if (error) {
        showToast('Error responding to request', 'error')
      } else {
        showToast(status === 'accepted' ? 'Friend request accepted!' : 'Friend request declined')
        loadFriendRequests()
        loadFriends()
      }
    }

    async function loadFriends() {
      const user = await checkAuth()
      const { data: friends } = await supabaseClient
        .from('friendships')
        .select(`
          *,
          requester:profiles!friendships_requester_id_fkey(full_name, profile_photo_url),
          addressee:profiles!friendships_addressee_id_fkey(full_name, profile_photo_url)
        `)
        .or(`requester_id.eq.${user.id},addressee_id.eq.${user.id}`)
        .eq('status', 'accepted')
        .order('created_at', { ascending: false })
      
      const container = document.getElementById('friendsList')
      if (friends && friends.length > 0) {
        container.innerHTML = friends.map(f => {
          const friend = f.requester_id === user.id ? f.addressee : f.requester
          return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                  ${friend.profile_photo_url ? 
                    `<img src="${friend.profile_photo_url}" class="w-10 h-10 rounded-full object-cover">` :
                    `<span class="text-sm font-bold text-purple-600">${friend.full_name[0]}</span>`
                  }
                </div>
                <div>
                  <p class="font-semibold text-sm">${friend.full_name}</p>
                  <p class="text-xs text-gray-500">Friend since ${new Date(f.updated_at || f.created_at).toLocaleDateString()}</p>
                </div>
              </div>
              <button onclick="removeFriend('${f.id}')" class="text-red-500 hover:text-red-700 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          `
        }).join('')
      } else {
        container.innerHTML = '<p class="text-gray-500 italic text-center py-4">No friends yet</p>'
      }
    }

    async function removeFriend(friendshipId) {
      if (!confirm('Are you sure you want to remove this friend?')) return
      
      const { error } = await supabaseClient
        .from('friendships')
        .delete()
        .eq('id', friendshipId)
      
      if (error) {
        showToast('Error removing friend', 'error')
      } else {
        showToast('Friend removed')
        loadFriends()
      }
    }

    async function loadAchievements() {
      const user = await checkAuth()
      const { data: userAchievements } = await supabaseClient
        .from('user_achievements')
        .select('achievements(*)')
        .eq('user_id', user.id)
      
      const container = document.getElementById('achievementsList')
      if (userAchievements && userAchievements.length > 0) {
        container.innerHTML = userAchievements.map(ua => `
          <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
            <div class="text-2xl mb-1">${ua.achievements.icon}</div>
            <div class="text-xs font-bold">${ua.achievements.name}</div>
            <div class="text-xs text-gray-600">${ua.achievements.points} pts</div>
          </div>
        `).join('')
      }
    }

    // Make functions available globally
    window.buyCoins = buyCoins
    window.respondToRequest = respondToRequest
    window.removeFriend = removeFriend

    loadProfile().then(() => {
      loadFriends()
      loadFriendRequests()
      loadAchievements()
    })
  </script>
</body>
</html>
